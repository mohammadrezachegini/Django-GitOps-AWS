name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  AWS_REGION: us-east-1
  ECR_REPOSITORY: 381492238320.dkr.ecr.us-east-1.amazonaws.com/django-gitops/django-api
  EKS_CLUSTER_NAME: django-gitops-eks

jobs:
  # ── Job 1: Test ─────────────────────────────────────────────────────────────
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    services:
      # Spin up a real PostgreSQL for tests — same version as prod
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: testdb
          POSTGRES_USER: testuser
          POSTGRES_PASSWORD: testpassword
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 5s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          cd app
          pip install -r requirements.txt

      - name: Run Django tests
        working-directory: app/src/django_app
        env:
          SECRET_KEY: "ci-test-secret-key"
          DEBUG: "True"
          DB_NAME: testdb
          DB_USER: testuser
          DB_PASSWORD: testpassword
          DB_HOST: localhost
          DB_PORT: "5432"
          ALLOWED_HOSTS: "localhost"
        run: python manage.py test

  # ── Job 2: Build & Push ─────────────────────────────────────────────────────
  build-and-push:
    name: Build and Push to ECR
    runs-on: ubuntu-latest
    needs: test    # Only runs if tests pass
    if: github.ref == 'refs/heads/main'    # Only on main branch, not PRs

    outputs:
      # Pass the image tag to the next job
      image_tag: ${{ steps.meta.outputs.tag }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Generate image tag
        id: meta
        # Use the short git SHA as the image tag.
        # This gives you a unique, traceable tag for every build.
        # You can always look at a running pod's image tag and find
        # exactly which commit it's running.
        run: echo "tag=sha-$(echo ${{ github.sha }} | cut -c1-7)" >> $GITHUB_OUTPUT

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./app
          push: true
          tags: |
            ${{ env.ECR_REPOSITORY }}:${{ steps.meta.outputs.tag }}
            ${{ env.ECR_REPOSITORY }}:latest

  # ── Job 3: Update K8s manifest ──────────────────────────────────────────────
  update-manifest:
    name: Update Image Tag in K8s Manifest
    runs-on: ubuntu-latest
    needs: build-and-push    # Only runs after image is pushed

    steps:
      - name: Checkout code
        # Use a token with write access so we can push back to the repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Update image tag in dev overlay
        # This is the GitOps-critical step:
        # We update the newTag in kustomization.yaml with the new SHA.
        # ArgoCD watches this file — it detects the change within 3 minutes
        # and automatically deploys the new image to EKS.
        run: |
          cd k8s/overlays/dev
          sed -i "s|newTag:.*|newTag: ${{ needs.build-and-push.outputs.image_tag }}|" kustomization.yaml
          cat kustomization.yaml   # Print for debugging

      - name: Commit and push updated manifest
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add k8s/overlays/dev/kustomization.yaml
          git diff --staged --quiet || git commit -m "ci: update dev image to ${{ needs.build-and-push.outputs.image_tag }}"
          git push